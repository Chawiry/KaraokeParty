{% extends "layout.html" %}

{% block body %}
    <center>
    <h1>Karaoke Party</h1>
    {% if singers != "" %}
      <h2>{{ song_name }} ‚Üí üéôÔ∏è{{ singers }}</h2>
    {% else %} 
      <h2>{{ song_name }}</h2>
    {% endif %}

    </center>
    <div id="player"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      let player;
      let song_urls = "{{ vid_ids }}".split(',');
      let url_index = 0;
      let urls_list_length = song_urls.length;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          videoId: song_urls[url_index],
          width: '100%',
          height: 720,
          playerVars: {
            'autoplay': 0,
            'controls': 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
            'onError' : onPlayerError
          }
        });

        UpdateUrlIndexDisplay();
      }
      
      function onPlayerReady(event) {
        //player.playVideo()
      }

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          //Clicked play make it allowfullscreen
          player.getIframe().requestFullscreen();
        }
        if (event.data == YT.PlayerState.ENDED) {
          advance_queue()
        }
      }

      function advance_queue() { 
        fetch('/advance_queue', {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({song_id: '{{ song_id }}'})
        })
          .then(() => {
            window.location.href = '{{ url_for('visualizer') }}'
          });
      }

      function onPlayerError(event) {
        if (event.data === 101 || event.data === 150)
        {
          //Change url, if no more urls show error
          if (url_index + 1 < urls_list_length)
          {
            cycleUrl(1)
          } else {
            document.getElementById("error").innerHTML = "<h3>Video can't be embeded, Please play on the official Youtube Page and Skip the song when ready <input type='button' value='Skip' onClick='advance_queue();' /> </h3>";
          }

        }
      }

      function cycleUrl(dir) {
        url_index = ((url_index + dir) % urls_list_length + urls_list_length) % urls_list_length;
        player.loadVideoById(song_urls[url_index]);
        UpdateUrlIndexDisplay();
      }

      function UpdateUrlIndexDisplay() {
        document.getElementById("url_index_display").innerHTML = (url_index + 1) + "/" + song_urls.length;
      }

    </script>
    
    <h6>
      If you don't like the video you can change it here: 
    <input type="button" value="‚¨ÖÔ∏è" onClick="cycleUrl(-1);" />
    <input type="button" value="‚û°Ô∏è" onClick="cycleUrl(1);" />
    <div id="url_index_display" style="display: inline-block;"> 0/0</div>
    </h6>

    <div id="error" style="color: red;"></div>

    {% if next_song_name != "" %}
      <div>
        <h4>NEXT UP: {{ next_song_name }}
        {% if next_singers %}
           ‚Üí üéôÔ∏è{{ next_singers}}
        {% endif %}
        </h4>
      </div>
    {% else %} 
      <div><h4>NEXT UP: THE QUEUE IS EMPTY, ADD MORE SONGS</h4></div>
    {% endif %}

{% endblock %}
