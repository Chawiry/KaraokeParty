{% extends "layout.html" %}

{% block body %}
    <center>
    <!-- <h2>Karaoke Party</h2> -->
    {% if singers != "" %}
      <h3>{{ song_name }} ‚Üí üéôÔ∏è{{ singers }}</h3>
    {% else %} 
      <h3>{{ song_name }}</h3>
    {% endif %}

    </center>

    <div class="player-wrapper">
      <div id="player" class="player"></div>
    <!-- </center> -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      let player;
      let song_urls = "{{ vid_ids }}".split(',');
      let url_index = 0;
      let urls_list_length = song_urls.length;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          videoId: song_urls[url_index],
          width: '100%',
          height: 720,
          playerVars: {
            'autoplay': 0,
            'controls': 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange,
            'onError' : onPlayerError
          }
        });

        UpdateUrlIndexDisplay();
      }
      
      function onPlayerReady(event) {
        //player.playVideo();
        setTimeout(function () {
          player.playVideo();
          player.getIframe().requestFullscreen();
        }, 5000);
      }

      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          //Clicked play make it allowfullscreen
          player.getIframe().requestFullscreen();
        }
        if (event.data == YT.PlayerState.ENDED) {
          advance_queue()
        }
      }

      function advance_queue() { 
        fetch('/advance_queue', {
          method: "POST",
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({song_id: '{{ song_id }}'})
        })
          .then(() => {
            window.location.href = '{{ url_for('visualizer') }}'
          });
      }

      let vids_with_errors = 0;
      function onPlayerError(event) {
        if (event.data === 101 || event.data === 150)
        {
          //Change url, if show embbeding error
          if (url_index + 1 < urls_list_length)
          {
            vids_with_errors++;
            cycleUrl(1)
          } else if (vids_with_errors >= urls_list_length) {
            document.getElementById("error").innerHTML = "<h3>Video can't be embeded, Please play on the official Youtube Page and Skip the song when ready</h3>";
          }

        }
      }

      function cycleUrl(dir) {
        url_index = ((url_index + dir) % urls_list_length + urls_list_length) % urls_list_length;
        player.cueVideoById(song_urls[url_index]);
        UpdateUrlIndexDisplay();
      }

      function UpdateUrlIndexDisplay() {
        document.getElementById("url_index_display").innerHTML = (url_index + 1) + "/" + song_urls.length;
      }

    </script>
    
      <h6 style="display:flex; justify-content: space-between; align-items:center; width:100%;">
        <div style="display: flex; align-items: center;">
          Alt Video:
          <img class='Button' onClick="cycleUrl(-1)" src=" {{ url_for('static', filename='UI/GuitarLeft.png') }}" alt="‚Üê">
          <img class='Button' onClick="cycleUrl(1)" src=" {{ url_for('static', filename='UI/GuitarRight.png') }}" alt="‚Üí">
          <span id="url_index_display"> 0/0</span>
        </div>

        <div> 
          <a class='btn btn-danger' onClick='advance_queue();'>Skip</a>
        </div>

      </h6>
    </div>
    <div id="error" style="color: red;"></div>

    {% if next_song_name != "" %}
      <div>
        <h4>NEXT UP:</h4>
        <h5>
          üéµ {{ next_song_name }}
          {% if next_singers %}
            ‚Üí üéôÔ∏è{{ next_singers}}
          {% endif %}
        </h5>
      </div>
    {% else %} 
      <div><h4>NEXT UP:</h4> <h6>THE QUEUE IS EMPTY, ADD MORE SONGS</h6></div>
    {% endif %}
    
    <div class="qr_container">
      <div id="queue">
        <h5 for="queue_qr">Queue</h5>
        <a href="{{ url_for('queue') }}">
          <img id="queue_qr" src="data:image/png;base64,{{ queue_qr }}" alt="Qr code for mobile app should apear here">
        </a>
      </div>

      <div id="wifi">
        <h5 for="wifi_qr">Wifi</h5>
        <img id="wifi_qr" src="data:image/png;base64,{{ wifi_qr }}" alt="Qr for wifi">
      </div>
    </div>
{% endblock %}
